name: CI/CD Pipeline

permissions: {}

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  NODE_VERSION: 20.18.0
  PNPM_VERSION: 9.15.0

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Run lint
        run: pnpm lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint]
    # Heavy build skips draft PRs and Dependabot but runs on pushes
    if: github.event_name != 'pull_request' || (!github.event.pull_request.draft && github.actor != 'dependabot[bot]')
    permissions:
      contents: read
      actions: write
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Restore Next.js cache
        id: next-cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .next/cache
            .turbo
          key: next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'next.config.mjs', 'tsconfig.json') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: Next.js cache summary
        run: |
          echo "Next.js cache hit: ${{ steps.next-cache.outputs.cache-hit }}" >> "$GITHUB_STEP_SUMMARY"
        shell: bash

      - name: Build application
        run: pnpm build

      - name: Save Next.js cache
        if: success() && github.actor != 'dependabot[bot]' && !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork)
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .next/cache
            .turbo
          key: next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'next.config.mjs', 'tsconfig.json') }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: next-build
          path: .next
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

      - name: Generate bundle size summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## Bundle Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next" ]; then
            echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Build artifacts are available in the next-build artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Build directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    # No dependencies to allow parallel execution with lint and test
    permissions:
      contents: read
      actions: write
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Vulnerability audit
        continue-on-error: true
        run: pnpm audit --audit-level=high

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@f15cb8b37b9b70056bc82a8eb7151f75fad27a71 # v3.90.13
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before }}
          head: HEAD

  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    needs: [build, security-audit, secret-scanning]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 10
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

  update-version-badge:
    name: Update Version Badge
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update version badge in README.md
        run: |
          node -e "
          const fs = require('fs');
          const readme = fs.readFileSync('README.md', 'utf8');
          const version = process.env.VERSION;
          const oldBadgePattern = /!\[version\]\(https:\/\/img\.shields\.io\/badge\/version-[^-]+-blue\)/;
          const newBadge = \`![version](https://img.shields.io/badge/version-\${version}-blue)\`;

          if (!oldBadgePattern.test(readme)) {
            console.error('Version badge pattern not found in README.md');
            process.exit(1);
          }

          const updatedReadme = readme.replace(oldBadgePattern, newBadge);

          if (updatedReadme === readme) {
            console.error('Version badge was not updated');
            process.exit(1);
          }

          fs.writeFileSync('README.md', updatedReadme);
          console.log('Version badge updated successfully');
          "
        env:
          VERSION: ${{ steps.get_version.outputs.version }}

      - name: Commit and push version badge update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update version badge to ${{ steps.get_version.outputs.version }}"
            git push
          fi
